import React, { useState } from 'react';

// Main App component for the student guide application
const App = () => {
  // State to manage which tab is currently active. 'intro' is the default active tab.
  const [activeTab, setActiveTab] = useState('intro');
  // State for the AI assistant's question input
  const [aiQuestion, setAiQuestion] = useState('');
  // State for the AI assistant's answer
  const [aiAnswer, setAiAnswer] = useState('');
  // State for loading indicator during AI API call
  const [isLoadingAi, setIsLoadingAi] = useState(false);
  // State for error messages from AI API call
  const [aiError, setAiError] = useState('');

  // Function to handle asking a question to the Gemini AI
  const askAI = async () => {
    if (!aiQuestion.trim()) {
      setAiError('אנא הזן שאלה לפני שליחה.');
      return;
    }

    setIsLoadingAi(true);
    setAiAnswer('');
    setAiError('');

    try {
      // Construct the prompt for the LLM
      const prompt = `השב לשאלה הבאה בנוגע לבגרות הגמישה או מיומנויות למידה, או כל נושא רלוונטי אחר לתלמידים, בצורה תמציתית וברורה: ${aiQuestion}`;
      let chatHistory = [];
      chatHistory.push({ role: "user", parts: [{ text: prompt }] });

      const payload = { contents: chatHistory };
      const apiKey = ""; // API key will be provided by the Canvas environment
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const result = await response.json();

      if (result.candidates && result.candidates.length > 0 &&
          result.candidates[0].content && result.candidates[0].content.parts &&
          result.candidates[0].content.parts.length > 0) {
        const text = result.candidates[0].content.parts[0].text;
        setAiAnswer(text);
      } else {
        setAiError('אירעה שגיאה בקבלת התשובה מהבינה המלאכותית. אנא נסה שוב.');
        console.error('Unexpected API response structure:', result);
      }
    } catch (error) {
      setAiError('שגיאה בתקשורת עם השרת. אנא בדוק את חיבור האינטרנט ונסה שוב.');
      console.error('Error calling Gemini API:', error);
    } finally {
      setIsLoadingAi(false);
    }
  };


  // Define the content for each tab. Each key represents a tab, and its value is an object
  // containing the title of the tab and its JSX content.
  const tabsContent = {
    intro: {
      title: 'ברוכים הבאים!',
      content: (
        <div className="space-y-4 text-gray-700">
          <p className="text-lg font-semibold text-blue-700">ברוך הבא/ה!</p>
          <p>מדריך זה נועד לסייע לך להכיר את המתווה החדש של הבגרות הגמישה ואת המערכת הדיגיטלית שבאמצעותה תבצע את המשימות. התפקיד שלך בתהליך הלמידה הוא משמעותי, וחשוב שתכיר את כל הכלים והתהליכים העומדים לרשותך.</p>
        </div>
      ),
    },
    whatIsBagrut: {
      title: 'מהי הבגרות הגמישה?',
      content: (
        <div className="space-y-4 text-gray-700">
          <h3 className="text-xl font-bold text-blue-800">הציון הסופי שלך מורכב משלושה חלקים:</h3>
          <ul className="list-disc list-inside space-y-2">
            <li><span className="font-semibold">35% בחינה חיצונית:</span> בחינה רגילה שתתקיים בבית הספר.</li>
            <li><span className="font-semibold">35% משימות מתוקשבות:</span> שתי משימות שתבצע/י במהלך השנה במערכת דיגיטלית. משימות אלו בוחנות מיומנויות ולא רק ידע.</li>
            <li><span className="font-semibold">30% הערכה פנימית:</span> ציון הניתן על ידי בית הספר שלך.</li>
          </ul>
        </div>
      ),
    },
    skills: {
      title: 'מיומנויות חשובות',
      content: (
        <div className="space-y-4 text-gray-700">
          <p>המשימות המתוקשבות נועדו לעזור לך לפתח מיומנויות חשובות למאה ה-21. הנה כמה מהן:</p>
          <ul className="list-disc list-inside space-y-2">
            <li><span className="font-semibold">למידה עצמאית:</span> היכולת להציב לעצמך יעדים, לנהל את הזמן שלך ולחשוב על תהליך הלמידה.</li>
            <li><span className="font-semibold">פתרון בעיות:</span> חשיבה ביקורתית, ניתוח נתונים והסקת מסקנות, והצגת טיעונים בצורה משכנעת.</li>
            <li><span className="font-semibold">עבודת צוות ותקשורת:</span> היכולת לעבוד בשיתוף פעולה עם חברים לכיתה, לתקשר בצורה ברורה ולתת משוב.</li>
            <li><span className="font-semibold">אוריינות דיגיטלית:</span> שימוש יעיל ובטוח בכלים דיגיטליים, איתור והערכת מידע ממקורות שונים וכיבוד זכויות יוצרים.</li>
            <li><span className="font-semibold">יצירתיות ויוזמה:</span> פיתוח רעיונות חדשים, חשיבה מקורית ולקיחת יוזמה.</li>
          </ul>
        </div>
      ),
    },
    system: {
      title: 'התחברות וביצוע משימות',
      content: (
        <div className="space-y-4 text-gray-700">
          <p>המשימות מתבצעות בפורטל דיגיטלי מיוחד של משרד החינוך. הנה מדריך פשוט כיצד להתחבר ולבצע את המשימות:</p>
          <ol className="list-decimal list-inside space-y-3">
            <li><span className="font-semibold">כניסה למערכת:</span> היכנס/י ל"בית הספר הוירטואלי" של משרד החינוך.</li>
            <li><span className="font-semibold">מסך ראשי:</span> לאחר הכניסה, תגיע/י למסך הראשי של הבגרות הגמישה. במסך זה תוכל/י לראות את כל המשימות שהמורה הקצה/ה לך, כולל שם המשימה, תאריך ההגשה והסטטוס שלה (האם היא פתוחה, בטיפול או הוגשה).</li>
            <li><span className="font-semibold">הכרות עם המשימה:</span> לאחר שתבחר/י במשימה, תגיע/י למסך המשימה. במסך זה תמצא/י את כל המידע שאתה צריך/ה:
              <ul className="list-disc list-inside mr-5 space-y-1">
                <li><span className="font-semibold">הסבר מפורט:</span> תיאור המשימה והדרישות.</li>
                <li><span className="font-semibold">סרטון הדרכה:</span> סרטון שמסביר את המשימה ואת אופן הביצוע.</li>
                <li><span className="font-semibold">שלבי המשימה:</span> פירוט השלבים השונים ותאריכי היעד לכל שלב.</li>
                <li><span className="font-semibold">אזורי עבודה:</span> חלקים שיתופיים (כל חברי הצוות יכולים לערוך) וחלקים אישיים (רק אתה יכול לערוך).</li>
              </ul>
            </li>
            <li><span className="font-semibold">שמירה והגשה:</span> במהלך העבודה על המשימה, חשוב מאוד ללחוץ על <span className="font-bold text-red-600">"שמירה"</span>, כיוון שהשמירה אינה אוטומטית. בסיום המשימה, עליך לבצע "הגשה". רק לאחר שכל חברי הצוות הגישו את המשימה, היא תועבר לבדיקת המורה.</li>
          </ol>
        </div>
      ),
    },
    grades: {
      title: 'ציונים',
      content: (
        <div className="space-y-4 text-gray-700">
          <h3 className="text-xl font-bold text-blue-800">מה קורה אם לא מרוצים מהציון?</h3>
          <p>אם לא תהיה/י מרוצה מהציון שתקבל/י על שתי המשימות, תוכל/י לגשת לבחינה חיצונית על הנושאים של שתי המשימות גם יחד. לא ניתן לגשת לבחינה רק על נושא של משימה אחת.</p>
        </div>
      ),
    },
    help: {
      title: 'קבלת עזרה',
      content: (
        <div className="space-y-6 text-gray-700">
          <p>אם אתה נתקל/ת בבעיה טכנית או שאלות בנוגע למשימה, תוכל/י לקבל עזרה:</p>
          <ul className="list-disc list-inside space-y-2">
            <li><span className="font-semibold">הודעות למורה:</span> בפינה השמאלית העליונה של המערכת תראה/י אייקון של בועת דיבור, המיועד להודעות אישיות מהתלמידים למורה.</li>
            <li><span className="font-semibold">הודעות מערכת:</span> אייקון הפעמון מיועד להודעות מערכת.</li>
            <li><span className="font-semibold">מוקד תמיכה ארצי:</span> מוקד שירות זמין למענה טלפוני.</li>
            <li><span className="font-semibold">טלפון:</span> 6552* או 073-3983960, שלוחה 9.</li>
            <li><span className="font-semibold">שעות פעילות:</span> ימים א'-ה' בין 7:30-18:00 וביום ו' בין 8:00-14:30.</li>
          </ul>

          {/* AI Assistant Section */}
          <div className="mt-8 p-6 bg-blue-50 rounded-lg shadow-md border border-blue-200">
            <h3 className="text-xl font-bold text-blue-800 mb-4 flex items-center">
              ✨ שאל את הבינה המלאכותית ✨
            </h3>
            <p className="mb-4 text-gray-600">
              יש לך שאלה כללית על הבגרות הגמישה, מיומנויות למידה, או כל נושא שקשור ללימודים?
              שאל/י כאן וקבל/י תשובה מיידית!
            </p>
            <textarea
              className="w-full p-3 border border-blue-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4 text-right"
              rows="4"
              placeholder="הקלד/י את שאלתך כאן..."
              value={aiQuestion}
              onChange={(e) => setAiQuestion(e.target.value)}
            ></textarea>
            <button
              className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition duration-300 ease-in-out flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
              onClick={askAI}
              disabled={isLoadingAi}
            >
              {isLoadingAi ? (
                <>
                  <svg className="animate-spin -mr-1 ml-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  טוען תשובה...
                </>
              ) : (
                'שאל/י את הבינה המלאכותית ✨'
              )}
            </button>

            {aiError && (
              <p className="text-red-600 mt-3 text-sm text-center">{aiError}</p>
            )}

            {aiAnswer && (
              <div className="mt-5 p-4 bg-white border border-blue-300 rounded-md shadow-inner">
                <h4 className="font-semibold text-blue-700 mb-2">תשובת הבינה המלאכותית:</h4>
                <p className="text-gray-800 whitespace-pre-wrap">{aiAnswer}</p>
              </div>
            )}
          </div>
        </div>
      ),
    },
  };

  return (
    // Main container for the application, setting up RTL direction and basic styling
    <div dir="rtl" className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 font-sans flex flex-col items-center">
      {/* Central content wrapper with shadow and rounded corners */}
      <div className="w-full max-w-2xl bg-white rounded-xl shadow-2xl overflow-hidden">
        {/* Header section with school name and guide title */}
        <div className="bg-blue-600 text-white p-6 text-center rounded-t-xl">
          <p className="text-lg font-semibold mb-1">הרב תחומי למדעים ולאמנויות עמל חדרה</p>
          <h1 className="text-3xl font-extrabold mb-2">מדריך לתלמיד: הבגרות הגמישה</h1>
          <p className="text-lg opacity-90">הכלים והמיומנויות שלך</p>
        </div>

        {/* Tabs Navigation: dynamically rendered based on tabsContent keys */}
        <div className="flex justify-around bg-blue-700 text-white text-sm sm:text-base md:text-lg lg:text-xl font-bold border-b-2 border-blue-800">
          {Object.keys(tabsContent).map((tabKey) => (
            <button
              key={tabKey} // Unique key for each button for React list rendering
              className={`flex-1 py-3 px-2 text-center transition-all duration-300 ease-in-out
                ${activeTab === tabKey ? 'bg-blue-800 text-yellow-300 border-b-4 border-yellow-300' : 'hover:bg-blue-600 hover:text-white'}`}
              onClick={() => setActiveTab(tabKey)} // Update active tab on click
            >
              {tabsContent[tabKey].title.split(':')[0]} {/* Display only the main title part */}
            </button>
          ))}
        </div>

        {/* Tab Content Area: displays content based on the activeTab state */}
        <div className="p-6 bg-white rounded-b-xl">
          <h2 className="text-2xl sm:text-3xl font-extrabold text-blue-700 mb-4 text-center">
            {tabsContent[activeTab].title}
          </h2>
          {tabsContent[activeTab].content}
        </div>
      </div>
    </div>
  );
};

export default App; // Export the App component as default
